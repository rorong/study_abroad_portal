<%# University Header %>
<div class="container-fluid p-0">
  <div class="bg-primary text-white py-5">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="display-4 mb-3"><%= @university.name %></h1>
          <% if @university.address.present? || @university.city.present? %>
            <p class="lead mb-2">
              <%= [@university.address, @university.city].compact.join(", ") %>
            </p>
          <% end %>
          <p class="lead mb-0"><%= @university.country %></p>
        </div>
        <div class="col-md-4 text-md-end">
          <% if @university.latitude.present? && @university.longitude.present? %>
            <div id="university-map" style="height: 200px; width: 100%; border-radius: 8px;"></div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# University Details %>
  <div class="container py-5">
    <div class="row">
      <div class="col-md-4">
        <%# Basic Information %>
        <div class="card mb-4">
          <div class="card-body">
            <h2 class="card-title h4 mb-4">Basic Information</h2>
            <div class="list-group list-group-flush">
              <div class="list-group-item">
                <strong>Type:</strong> <%= @university.type_of_university %>
              </div>
              <div class="list-group-item">
                <strong>Category:</strong> <%= @university.category %>
              </div>
              <div class="list-group-item">
                <strong>Established:</strong> <%= @university.established_in %>
              </div>
              <div class="list-group-item">
                <strong>Status:</strong> <%= @university.active ? "Active" : "Inactive" %>
              </div>
              <% if @university.code.present? %>
                <div class="list-group-item">
                  <strong>University Code:</strong> <%= @university.code %>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <%# Rankings %>
        <div class="card mb-4">
          <div class="card-body">
            <h2 class="card-title h4 mb-4">Rankings</h2>
            <div class="list-group list-group-flush">
              <div class="list-group-item">
                <strong>World Ranking:</strong> <%= @university.world_ranking || 'Not Available' %>
              </div>
              <div class="list-group-item">
                <strong>QS Ranking:</strong> <%= @university.qs_ranking || 'Not Available' %>
              </div>
              <div class="list-group-item">
                <strong>National Ranking:</strong> <%= @university.national_ranking || 'Not Available' %>
              </div>
            </div>
          </div>
        </div>

        <%# Student Information %>
        <div class="card mb-4">
          <div class="card-body">
            <h2 class="card-title h4 mb-4">Student Body</h2>
            <div class="list-group list-group-flush">
              <div class="list-group-item">
                <strong>Total Students:</strong> 
                <%= @university.total_students ? number_with_delimiter(@university.total_students) : 'Not Available' %>
              </div>
              <div class="list-group-item">
                <strong>International Students:</strong>
                <%= @university.total_international_students ? number_with_delimiter(@university.total_international_students) : 'Not Available' %>
              </div>
            </div>
          </div>
        </div>

        <%# Facilities & Features %>
        <div class="card mb-4">
          <div class="card-body">
            <h2 class="card-title h4 mb-4">Facilities & Features</h2>
            <div class="list-group list-group-flush">
              <div class="list-group-item d-flex align-items-center">
                <i class="fas <%= @university.conditional_offers ? 'fa-check text-success' : 'fa-times text-danger' %> me-2"></i>
                <span>Conditional Offers</span>
              </div>
              <div class="list-group-item d-flex align-items-center">
                <i class="fas <%= @university.lateral_entry_allowed ? 'fa-check text-success' : 'fa-times text-danger' %> me-2"></i>
                <span>Lateral Entry</span>
              </div>
              <div class="list-group-item d-flex align-items-center">
                <i class="fas <%= @university.on_campus_accommodation ? 'fa-check text-success' : 'fa-times text-danger' %> me-2"></i>
                <span>On-Campus Accommodation</span>
              </div>
              <% if @university.application_fee.present? %>
                <div class="list-group-item">
                  <strong>Application Fee:</strong> $<%= number_with_delimiter(@university.application_fee) %>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <%# Contact Information %>
        <div class="card">
          <div class="card-body">
            <h2 class="card-title h4 mb-4">Contact Information</h2>
            <div class="list-group list-group-flush">
              <% if @university.address.present? || @university.city.present? || @university.state.present? %>
                <div class="list-group-item">
                  <strong><i class="fas fa-map-marker-alt me-2"></i>Address:</strong><br>
                  <%= [@university.address, @university.city, @university.state, @university.post_code].compact.join(", ") %>
                </div>
              <% end %>
              <% if @university.switchboard_no.present? %>
                <div class="list-group-item">
                  <strong><i class="fas fa-phone me-2"></i>Switchboard:</strong><br>
                  <%= @university.switchboard_no %>
                </div>
              <% end %>
              <% if @university.website.present? %>
                <div class="list-group-item">
                  <strong><i class="fas fa-globe me-2"></i>Website:</strong><br>
                  <%= link_to @university.website, "http://#{@university.website}", target: '_blank' %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <%# Courses Section %>
      <div class="col-md-8">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2 class="card-title h4 mb-0">Available Courses</h2>
              <span class="badge bg-primary"><%= @courses.total_count %> Courses</span>
            </div>
            
            <% if @courses.any? %>
              <div class="row row-cols-1 row-cols-md-2 g-4">
                <% @courses.each do |course| %>
                  <div class="col">
                    <div class="card h-100 shadow-sm">
                      <div class="card-header bg-primary text-white">
                        <h5 class="card-title m-0"><%= course.name %></h5>
                      </div>
                      <div class="card-body">
                        <% if course.title.present? %>
                          <p class="card-subtitle text-muted mb-2"><%= course.title %></p>
                        <% end %>
                        <p class="mb-1"><strong>Department:</strong> <%= course.department.name %></p>
                        <p class="mb-1"><strong>Level:</strong> <%= course.level_of_course || "N/A" %></p>
                        <p class="mb-1"><strong>Duration:</strong> <%= course.course_duration %> months</p>
                        <p class="mb-1"><strong>Intake:</strong> <%= course.intake || "N/A" %></p>
                        <% if course.tuition_fee_international.present? %>
                          <p class="mb-1"><strong>Tuition (Intl):</strong> $<%= number_with_delimiter(course.tuition_fee_international) %></p>
                        <% end %>
                      </div>
                      <div class="card-footer bg-white border-0 text-center">
                        <%= link_to course_path(course), class: "btn btn-outline-primary w-100" do %>
                          <i class="fas fa-info-circle me-2"></i>View Details
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
              
              <%# Pagination %>
              <div class="d-flex justify-content-center mt-4">
                <%= paginate @courses %>
              </div>
            <% else %>
              <p class="text-muted text-center">No courses available at this university.</p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%# Map Initialization %>
<% if @university.latitude.present? && @university.longitude.present? %>
  <script>
    // Global variables
    let map;
    let marker;
    let infoWindow;

    // Initialize map function
    function initMap() {
      try {
        console.log('Initializing map...');
        
        // Check if map container exists
        const mapContainer = document.getElementById('university-map');
        if (!mapContainer) {
          console.error('Map container not found');
          return;
        }

        // Create map options
        const mapOptions = {
          zoom: 15,
          center: {
            lat: <%= @university.latitude.to_f %>,
            lng: <%= @university.longitude.to_f %>
          },
          mapTypeId: 'terrain',
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: false
        };

        // Initialize map
        map = new google.maps.Map(mapContainer, mapOptions);

        // Create marker
        marker = new google.maps.Marker({
          position: mapOptions.center,
          map: map,
          title: '<%= @university.name %>',
          animation: google.maps.Animation.DROP
        });

        // Create info window
        infoWindow = new google.maps.InfoWindow({
          content: `
            <div class="p-2">
              <h5 class="mb-2">${marker.getTitle()}</h5>
              <p class="mb-0">${mapOptions.center.lat.toFixed(6)}, ${mapOptions.center.lng.toFixed(6)}</p>
            </div>
          `
        });

        // Add click listener
        marker.addListener('click', () => {
          infoWindow.open(map, marker);
        });

        console.log('Map initialized successfully');
      } catch (error) {
        console.error('Error initializing map:', error);
        showMapError('Failed to initialize map. Please try again later.');
      }
    }

    function showMapError(message) {
      const mapContainer = document.getElementById('university-map');
      if (mapContainer) {
        mapContainer.innerHTML = `
          <div class="alert alert-warning m-0">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
          </div>
        `;
      }
    }

    // Load Google Maps API
    function loadGoogleMaps() {
      // Check if script is already loaded
      if (document.querySelector('script[src*="maps.googleapis.com/maps/api/js"]')) {
        console.log('Google Maps script already loaded');
        if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
          initMap();
        }
        return;
      }

      console.log('Loading Google Maps API...');
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyCjw3HIsW8WLLriMQ_u3wQng2ggRKRP2cg&callback=initMap`;
      script.async = true;
      script.defer = true;
      
      script.onerror = () => {
        console.error('Failed to load Google Maps API');
        showMapError('Failed to load Google Maps. Please check your internet connection.');
      };

      document.head.appendChild(script);
    }

    // Start loading when document is ready
    if (document.readyState === 'complete') {
      loadGoogleMaps();
    } else {
      window.addEventListener('load', loadGoogleMaps);
    }
  </script>
<% end %>

<%# Custom Styles %>
<style>
  .card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .card-header {
    border-bottom: none;
  }
  
  .card-footer {
    border-top: none;
  }
  
  .bg-primary {
    background: linear-gradient(45deg, #0d6efd, #0a58ca) !important;
  }
  
  .btn-outline-primary:hover {
    background: linear-gradient(45deg, #0d6efd, #0a58ca);
    border-color: transparent;
  }
  
  .list-group-item {
    border: none;
    padding: 1rem 0;
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }
  
  .list-group-item:last-child {
    border-bottom: none;
  }

  .text-success {
    color: #198754 !important;
  }

  .text-danger {
    color: #dc3545 !important;
  }
</style> 